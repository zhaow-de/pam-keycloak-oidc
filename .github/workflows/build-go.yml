name: Build and release

on:
  push:
    tags:
      - "v*"
      - "r*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-24.04
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "^1.24"
          cache: true

      - name: Run tests
        run: go test ./...

  # --- GoReleaser: builds RPM, DEB, tar.gz and creates GitHub Release ---
  release-packages:
    name: "Release packages (RPM + DEB)"
    needs: test
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "^1.24"
          cache: true

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload fixed-name packages (latest-friendly)
        run: |
          # Copy versioned RPM/DEB to fixed names for stable download URLs
          for f in dist/*.rpm; do
            arch=$(echo "$f" | grep -oP '(amd64|arm64)')
            cp "$f" "dist/pam-keycloak-oidc_${arch}.rpm"
          done
          for f in dist/*.deb; do
            arch=$(echo "$f" | grep -oP '(amd64|arm64)')
            cp "$f" "dist/pam-keycloak-oidc_${arch}.deb"
          done
          # Upload fixed-name copies to the same release
          gh release upload "${{ github.ref_name }}" \
            dist/pam-keycloak-oidc_amd64.rpm \
            dist/pam-keycloak-oidc_arm64.rpm \
            dist/pam-keycloak-oidc_amd64.deb \
            dist/pam-keycloak-oidc_arm64.deb \
            --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # --- Legacy: raw binaries only (no packaging) ---
  release-binaries:
    name: "Release binaries (legacy)"
    needs: test
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/r')
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "^1.24"
          cache: true

      - name: Build
        run: make all

      - name: Create release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            ./pam-keycloak-oidc.linux-amd64
            ./pam-keycloak-oidc.linux-arm64
            ./pam-keycloak-oidc.darwin-amd64
            ./pam-keycloak-oidc.darwin-arm64
            ./pam-keycloak-oidc.windows-amd64.exe
            ./pam-keycloak-oidc.windows-arm64.exe
